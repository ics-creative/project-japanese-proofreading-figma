<!--
  ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®UIã«é–¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™
  ãƒ–ãƒ©ã‚¦ã‚¶APIã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€Figmaã®ã€Œsceneã€ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“
-->
<style>
  .buttonClose {
    background: none;
    border: 1px solid #9F9F9F;
    color: #9F9F9F;
    box-sizing: border-box;
    border-radius: 20px;
    cursor: pointer;
    line-height: 16px;
    outline: none;
    padding: 7px 16px 6px;
    text-align: center;
  }
  .buttonClose:hover {
    background-color: #9F9F9F;
    color: #ffffff;
  }
</style>
<h2>ãƒ†ã‚­ã‚¹ãƒˆæ ¡æ­£ãã‚“</h2>
<p id="characters"></p>
<p id="LintList"></p>
<button class="buttonClose" id="close">é–‰ã˜ã‚‹</button>
<script>
// ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
document.getElementById('close').onclick = () => {
  parent.postMessage({ pluginMessage: 'closePlugin' }, '*')
}

// ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã™ã‚‹å‡¦ç†ã§ã™
// ä»Šå›ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³èµ·å‹•æ™‚ã«ã€ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™
// - ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—é–‰ã˜ã‚‹
// - ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚ŒãŸå ´åˆãƒ†ã‚­ã‚¹ãƒˆæ ¡æ­£ãã‚“ã‚’å®Ÿè¡Œã—ã€è¡¨ç¤ºã™ã‚‹
window.onmessage = async (event) => {
  // ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ãŒé¸æŠã•ã‚ŒãŸéš›ã®å‡¦ç†
  if (event.data.pluginMessage.type === 'notTextNode') {
    alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„")
    parent.postMessage({ pluginMessage: 'closePlugin' }, '*')
    return
  }

  // ç¾åœ¨é¸æŠä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆ
  const sentences = event.data.pluginMessage.current

  // èª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆä»®ç½®ãï¼‰
  document.getElementById("characters").innerText = "èª­ã¿è¾¼ã¿ä¸­";

  // ãƒ†ã‚­ã‚¹ãƒˆæ ¡æ­£ãã‚“ã‚’å®Ÿè¡Œã—ã¾ã™
  // å¤–éƒ¨ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯HTMLå´ã‹ã‚‰ã®ã¿è¡Œãˆã€fetch APIãŒæ‰±ãˆãªã„ã®ã§XMLHttpRequestã‚’ä½¿ã„ã¾ã™
  // å‚è€ƒè¨˜äº‹ï¼ˆhttps://www.figma.com/plugin-docs/making-network-requests/ï¼‰
  if (event.data.pluginMessage.type === 'networkRequest') {
    const request = new XMLHttpRequest()
    request.onreadystatechange = function()
    {
      const READYSTATE_COMPLETED = 4;
      const HTTP_STATUS_OK = 200;

      if( this.readyState === READYSTATE_COMPLETED
        && this.status === HTTP_STATUS_OK )
      {
        // ulè¦ç´ ã‚’å–å¾—
        const ul = document.getElementById('LintList');
        // å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…åˆ—ã‚’å–å¾—
        const messagesArray = JSON.parse(this.response).messages

        if(messagesArray.length <= 0){
          // ãƒ†ã‚­ã‚¹ãƒˆã«å•é¡ŒãŒç„¡ã„å ´åˆ

          // ulè¦ç´ å†…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          ul.innerHTML = "<li>ğŸ†—æ–‡ç« ã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>"
          // èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä»®ç½®ãï¼‰
          document.getElementById("characters").innerText = "èª­ã¿è¾¼ã¿å®Œäº†ï¼";
        } else {
          // ãƒ†ã‚­ã‚¹ãƒˆã«å•é¡ŒãŒã‚ã‚‹å ´åˆ

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®HTMLã‚¿ã‚°
          let lintListHtml = ""

          for (let count = 0; count < messagesArray.length; count++) {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’HTMLã‚¿ã‚°ã«æ•´å½¢ã—ã€å¤‰æ•°ã«æ ¼ç´
            lintListHtml = lintListHtml + "<li>âœ…" + messagesArray[count].message.replace( '\n', '</br>' ) + "</li>"
          }

          // ulè¦ç´ å†…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          ul.innerHTML = lintListHtml

          // èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä»®ç½®ãï¼‰
          document.getElementById("characters").innerText = "èª­ã¿è¾¼ã¿å®Œäº†ï¼";
        }
      }
    }
    // æ‹¡å¼µæ©Ÿèƒ½ä»¥å¤–ã®ç›®çš„ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ã§ã­ï¼
    const address = "https://textcheck-3c82d.firebaseapp.com/textlint";
    request.open('POST', address)
    request.setRequestHeader("Accept", "application/json; charset=UTF-8")
    request.setRequestHeader("Content-Type", "application/json; charset=UTF-8")
    request.send(JSON.stringify({sentences, type: "Figma"}))
  }
}

</script>
