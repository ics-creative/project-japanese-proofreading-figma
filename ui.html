<!--
  このファイルには、プラグインのUIに関するコードが格納されています
  ブラウザAPIにはアクセスできますが、Figmaの「scene」にはアクセスできません
-->
<style>
  .buttonClose {
    background: none;
    border: 1px solid #9F9F9F;
    color: #9F9F9F;
    box-sizing: border-box;
    border-radius: 20px;
    cursor: pointer;
    line-height: 16px;
    outline: none;
    padding: 7px 16px 6px;
    text-align: center;
  }
  .buttonClose:hover {
    background-color: #9F9F9F;
    color: #ffffff;
  }
</style>
<h2>テキスト校正くん</h2>
<p id="characters"></p>
<p id="LintList"></p>
<button class="buttonClose" id="close">閉じる</button>
<script>
// プラグインを閉じるボタン
document.getElementById('close').onclick = () => {
  parent.postMessage({ pluginMessage: 'closePlugin' }, '*')
}

// メインコードからデータを渡された際に実行する処理です
// 今回はプラグイン起動時に、以下の処理を行います
// - テキスト以外が選択された場合アラートを出し閉じる
// - テキストが選択された場合テキスト校正くんを実行し、表示する
window.onmessage = async (event) => {
  // テキスト以外が選択された際の処理
  if (event.data.pluginMessage.type === 'notTextNode') {
    alert("テキストを選択してください")
    parent.postMessage({ pluginMessage: 'closePlugin' }, '*')
    return
  }

  // 現在選択中のテキスト
  const sentences = event.data.pluginMessage.current

  // 読み込み開始（仮置き）
  document.getElementById("characters").innerText = "読み込み中";

  // テキスト校正くんを実行します
  // 外部へのリクエストはHTML側からのみ行え、fetch APIが扱えないのでXMLHttpRequestを使います
  // 参考記事（https://www.figma.com/plugin-docs/making-network-requests/）
  if (event.data.pluginMessage.type === 'networkRequest') {
    const request = new XMLHttpRequest()
    request.onreadystatechange = function()
    {
      const READYSTATE_COMPLETED = 4;
      const HTTP_STATUS_OK = 200;

      if( this.readyState === READYSTATE_COMPLETED
        && this.status === HTTP_STATUS_OK )
      {
        // ul要素を取得
        const ul = document.getElementById('LintList');
        // 受け取ったメッセージの配列を取得
        const messagesArray = JSON.parse(this.response).messages

        if(messagesArray.length <= 0){
          // テキストに問題が無い場合

          // ul要素内にメッセージを表示
          ul.innerHTML = "<li>🆗文章に問題がありませんでした。</li>"
          // 読み込み完了（仮置き）
          document.getElementById("characters").innerText = "読み込み完了！";
        } else {
          // テキストに問題がある場合

          // メッセージを表示するためのHTMLタグ
          let lintListHtml = ""

          for (let count = 0; count < messagesArray.length; count++) {
            // メッセージをHTMLタグに整形し、変数に格納
            lintListHtml = lintListHtml + "<li>✅" + messagesArray[count].message.replace( '\n', '</br>' ) + "</li>"
          }

          // ul要素内にメッセージを表示
          ul.innerHTML = lintListHtml

          // 読み込み完了（仮置き）
          document.getElementById("characters").innerText = "読み込み完了！";
        }
      }
    }
    // 拡張機能以外の目的でアクセスしないでね！
    const address = "https://textcheck-3c82d.firebaseapp.com/textlint";
    request.open('POST', address)
    request.setRequestHeader("Accept", "application/json; charset=UTF-8")
    request.setRequestHeader("Content-Type", "application/json; charset=UTF-8")
    request.send(JSON.stringify({sentences, type: "Figma"}))
  }
}

</script>
